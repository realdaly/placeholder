{% extends "dashboard/layout.html" %}
{% load static %}

{% block dynamicName %}الإعدادات العامة{% endblock %}

{% block body %}

<div x-data="{ modalOpen: false }" class="flex flex-col px-5 gap-y-5">

    <!-- edit title div -->
    <div class="flex items-center justify-between p-4 bg-white rounded-md dark:bg-darker">
        <div>
            <h6 class="text-xs font-medium leading-none text-gray-500 dark:text-primary-light">
            عنوان الموقع
            </h6>
            <span class="text-xl font-semibold">{{ configurations.title }}</span>
        </div>
        <button onclick="editTitle()" class="p-3 transition-all duration-300 bg-gray-200 rounded-lg hover:bg-gray-300" @click="modalOpen = true;$nextTick(() => { $refs.input.focus(); })">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
            </svg>
        </button>
    </div>

    <!-- edit logo div -->
    <div class="flex items-center justify-between p-4 bg-white rounded-md dark:bg-darker">
        <div>
            <h6 class="mb-5 text-xs font-medium leading-none text-gray-500 dark:text-primary-light">
                شعار الموقع
            </h6>
            <img 
                src="{{ configurations.logo.image.url }}" 
                class="p-5 border rounded-lg w-36" 
            >
        </div>
        <button onclick="editLogo()" class="p-3 transition-all duration-300 bg-gray-200 rounded-lg hover:bg-gray-300" @click="modalOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
            </svg>
        </button>
        
    </div>

    <!-- edit social media div -->
    <div class="flex items-center justify-between p-4 bg-white rounded-md dark:bg-darker">
        <div>
            <h6 class="mb-5 text-xs font-medium leading-none text-gray-500 dark:text-primary-light">
                مواقع التواصل الإجتماعي
            </h6>
            <img 
                src="{{ configurations.logo.image.url }}" 
                class="p-5 border rounded-lg w-36" 
            >
        </div>
        <button onclick="editLogo()" class="p-3 transition-all duration-300 bg-gray-200 rounded-lg hover:bg-gray-300" @click="modalOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
            </svg>
        </button>
        
    </div>
    
    <!-- Modal -->
    <div
        @keydown.esc="modalOpen = false"
        x-show="modalOpen"
        :class="{'opacity-0': !modalOpen}"
        x-transition:enter="transition ease-out duration-100" 
        x-transition:enter-start="transform opacity-0" 
        x-transition:enter-end="transform opacity-100" 
        x-transition:leave="transition ease-in duration-75" 
        x-transition:leave-start="transform opacity-100" 
        x-transition:leave-end="transform opacity-0" 
        class="fixed top-0 left-0 flex items-center justify-center w-full h-full min-h-screen px-4 py-5 bg-black opacity-0 bg-opacity-90"
    >
        <div
            @click.outside="modalOpen = false"
            id="modal"
            class="max-w-screen-2xl px-8 py-12 min-w-[20%] text-center bg-white rounded-lg w-fit"
        >
        </div>
    </div>
    
</div>




<!-- backend model form -->
<form class="hidden" method="POST" id="editForm">
    {% csrf_token %}
    <input id="title" type="text" name="title" value="{{ configurations.title }}" maxlength="255">
    <input id="logo" type="text" name="logo" value="{{ configurations.logo.id }}">
</form>

<script>
    const modal = document.getElementById("modal")
    function editTitle(){
        modal.innerHTML = 
        ` <h3 class="pb-2 mb-3 text-xl font-bold text-dark sm:text-2xl">
            تعديل العنوان
        </h3>
    
        <input
            class="w-full px-4 py-2 border rounded-md dark:bg-darker dark:border-gray-700 focus:outline-none focus:ring focus:ring-primary-100 dark:focus:ring-primary-darker" 
            type="text" 
            placeholder="اكتب العنوان هنا" 
            required=""
            id="adminTitle"
            x-ref="input"
            x-on:keydown.enter="document.getElementById('title').value = document.getElementById('adminTitle').value;document.getElementById('editForm').submit()"
        >
        
        <div class="flex flex-wrap justify-center mt-5 -mx-3">
            <div class="w-1/6 px-3">
                <button
                    @click="modalOpen = false"
                    class="block w-full p-3 text-base font-bold text-center text-white transition bg-red-600 border rounded-lg"
                >
                    إلغاء
                </button>
            </div>
            <div class="w-1/6 px-3">
                <button
                    class="block w-full p-3 text-base font-bold text-center transition border rounded-lg bg-primary border-primary hover:bg-opacity-90"
                    x-on:click="document.getElementById('title').value = document.getElementById('adminTitle').value;document.getElementById('editForm').submit()"
                >
                    تم
                </button>
            </div>
        </div>`
    }

    function editLogo(){
        modal.innerHTML = 
            `<h3 class="pb-2 mb-3 text-xl font-bold text-dark sm:text-2xl">
                اختر صورة 
            </h3>
            <div id="imagesContainer" class="flex flex-wrap items-start justify-center gap-4 py-2"></div>
            <div class="mt-4">
                <button
                    id="loadMore"
                    class="block px-4 py-2 mx-auto text-base font-bold text-center text-white bg-gray-900 rounded-lg hover:bg-opacity-90 focus:outline-none focus:shadow-outline"
                >
                    المزيد
                </button>
            </div>
            <div class="flex flex-wrap justify-center mt-5 -mx-3">
                <div class="w-1/6 px-3">
                    <button
                        @click="modalOpen = false"
                        class="block w-full p-3 text-base font-bold text-center text-white transition bg-red-600 border rounded-lg"
                    >
                        إلغاء
                    </button>
                </div>
                <div class="w-1/6 px-3">
                    <button
                        class="block w-full p-3 text-base font-bold text-center transition border rounded-lg bg-primary border-primary hover:bg-opacity-90"
                        x-on:click="document.getElementById('editForm').submit()"
                    >
                        تم
                    </button>
                </div>
            </div>`
        fetchAndInsertImages()
    }

    async function fetchAndInsertImages(){
        let url = "{% url 'dashboard:images' %}"
        let options = {
            method: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            }
        }

        try {
            const response = await fetch(url, options)
            imagesData = await response.json()

            imagesData.context.forEach(image => {
                document.getElementById("imagesContainer").innerHTML += 
                `<div class="flex flex-col gap-y-2 w-36">
                    <div 
                        class="h-24 overflow-hidden transition-all border rounded-md cursor-pointer image hover:scale-110 w-36"
                        onclick="selectImage(this);document.getElementById('logo').value = this.querySelector('img').alt"
                    >
                        <img class="object-cover object-center w-full h-full" src="{{ media_path }}${image.image}" alt="${image.id}">
                    </div>
                    <p class="line-clamp-2">${image.title}</p>
                </div>`
            })
        } catch (error) {
            console.error("Error fetching images:", error)
        }
    }

    function selectImage(image){
        const images = document.querySelectorAll(".image")
        images.forEach(item => item.classList.remove("border-red-500", "scale-110", "border-2"))
        image.classList.add("border-red-500", "scale-110", "border-2")
    }

</script>

{% endblock %}